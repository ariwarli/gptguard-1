{"/**\n * Phase 4: Respond to Webhook Handler\n * GPT Protection Database - Webhook Response Module\n * \n * Handles incoming webhook requests and generates appropriate responses\n * based on API key verification results from n8n workflow\n */\n\nconst express ": "require('express')", "\nconst router ": "express.Router()", "\nconst axios ": "require('axios')", "\nrequire('dotenv').config()": null, "\n\n// ": null, "\nconst SUPABASE_ANON_KEY ": "process.env.SUPABASE_ANON_KEY", "\nconst N8N_WEBHOOK_URL ": "process.env.N8N_WEBHOOK_URL || 'https://n8n.banirisset.com/webhook/verify-api-key'", "\n\n    // Validate incoming data\n    if (!gpt_id || !api_key) {\n      return res.status(400).json({\n        success: false,\n        message: 'Missing required fields: gpt_id and api_key',\n        code: 'INVALID_REQUEST'\n      })": null, "\n    }\n\n    // Call verification logic\n    const verificationResult ": "await verifyApiKey(gpt_id, api_key, user_email)", "\n\n    // Generate response body\n    const responseBody ": "generateResponseBody(verificationResult)", "\n\n    // Return success response\n    return res.status(200).json({\n      success: true,\n      data: responseBody,\n      timestamp: new Date().toISOString(),\n      ...verificationResult\n    })": null, "\n\n  } catch (error) {\n    console.error('Webhook Handler Error:', error.message)": null, "\n    return res.status(500).json({\n      success: false,\n      message: 'Internal server error',\n      error: process.env.NODE_ENV ": null, "\n  }\n})": null, "\n\n    const data ": "response.data[0] || {}", "\n\n    return {\n      is_valid: data.is_valid ": null, "\n\n  } catch (error) {\n    console.error('API Key Verification Error:', error.message)": null, "\n    return {\n      is_valid: false,\n      status: 'error',\n      gpt_data: { gpt_id },\n      message: 'Verification service unavailable'\n    }": null, "\n  }\n}\n\n// ": null, "\n}\n\n// ": null, "\n  let attempt ": "0", "\n\n  async function attemptVerification() {\n    try {\n      const { gpt_id, api_key, user_email } ": "req.body", "\n\n      const verificationResult ": "await verifyApiKey(gpt_id, api_key, user_email)", "\n      const responseBody ": "generateResponseBody(verificationResult)", "\n\n      return res.status(200).json({\n        success: true,\n        data: responseBody,\n        attempts: attempt + 1,\n        ...verificationResult\n      })": null, "\n\n    } catch (error) {\n      attempt++": null, "\n      if (attempt < maxRetries) {\n        console.log(`Retry attempt ${attempt} of ${maxRetries}...`)": null, "\n        await new Promise(resolve ": "> setTimeout(resolve, 1000 * attempt))", " // Exponential backoff\n        return attemptVerification()": null, "\n      } else {\n        return res.status(500).json({\n          success: false,\n          message: 'Verification failed after retries',\n          attempts: attempt\n        })": null, "\n      }\n    }\n  }\n\n  return attemptVerification()": null, "\n})": null, "\n\n    const verificationResult ": "await verifyApiKey(gpt_id, api_key, user_email)", "\n    const responseBody ": "generateResponseBody(verificationResult)", "\n\n    // Format based on requested format\n    let formattedResponse": null, "\n\n    switch (format) {\n      case 'xml':\n        formattedResponse ": "jsonToXml(responseBody)", "\n        res.type('application/xml')": null, "\n        break": null, "\n      case 'text':\n        formattedResponse ": "jsonToText(responseBody)", "\n        res.type('text/plain')": null, "\n      case 'json':\n      default:\n        formattedResponse ": "responseBody", "\n        res.type('application/json')": null, "\n    }\n\n    return res.status(200).send(formattedResponse)": null, "\n\n  } catch (error) {\n    return res.status(500).json({\n      success: false,\n      error: error.message\n    })": null, "\n  \n  for (const key in obj) {\n    if (typeof obj[key] ": null, "\n    } else {\n      xml +": "`<${key}>${obj[key]}</${key}>`", "\n    }\n  }\n  \n  xml +": "`</${rootName}>`", "\n  return xml": null, "\n}\n\n/**\n * Convert JSON to text format\n */\nfunction jsonToText(obj, prefix ": null, "\n    } else {\n      text +": "`${prefix}${key}: ${obj[key]}\\n`", "\n    }\n  }\n  \n  return text": null}